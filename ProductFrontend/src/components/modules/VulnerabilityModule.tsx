import { useState, useEffect, createContext, useContext } from 'react';
import { toast } from 'sonner';
import { Loader2 } from 'lucide-react';
import {
  Search,
  RefreshCw,
  Eye,
  Clock,
  Shield,
  TrendingUp,
  Bell,
  CheckCircle,
  Building,
  Target,
  Activity,
  Flame,
  Users,
  ArrowUpRight,
  ArrowDownRight,
  Minus,
  FileWarning,
  Check
} from 'lucide-react';
import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip as RechartsTooltip, LineChart, Line, AreaChart, Area, XAxis, YAxis, CartesianGrid } from 'recharts';

// --- INTERNAL UI COMPONENTS ---

const Card = ({ className, children }: any) => <div className={`rounded-lg border bg-card text-card-foreground shadow-sm ${className || ''}`}>{children}</div>;
const CardHeader = ({ className, children }: any) => <div className={`flex flex-col space-y-1.5 p-6 ${className || ''}`}>{children}</div>;
const CardTitle = ({ className, children }: any) => <h3 className={`text-2xl font-semibold leading-none tracking-tight ${className || ''}`}>{children}</h3>;
const CardDescription = ({ className, children }: any) => <p className={`text-sm text-muted-foreground ${className || ''}`}>{children}</p>;
const CardContent = ({ className, children }: any) => <div className={`p-6 pt-0 ${className || ''}`}>{children}</div>;

const Badge = ({ variant = "default", className, children }: any) => {
  const variants: any = {
    default: "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
    secondary: "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
    destructive: "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
    outline: "text-foreground",
  };
  return <div className={`inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 ${variants[variant] || variants.default} ${className || ''}`}>{children}</div>;
};

const Button = ({ variant = "default", size = "default", className, children, ...props }: any) => {
  const variants: any = {
    default: "bg-primary text-primary-foreground hover:bg-primary/90",
    destructive: "bg-destructive text-destructive-foreground hover:bg-destructive/90",
    outline: "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
    secondary: "bg-secondary text-secondary-foreground hover:bg-secondary/80",
    ghost: "hover:bg-accent hover:text-accent-foreground",
    link: "text-primary underline-offset-4 hover:underline",
  };
  const sizes: any = {
    default: "h-10 px-4 py-2",
    sm: "h-9 rounded-md px-3",
    lg: "h-11 rounded-md px-8",
    icon: "h-10 w-10",
  };
  return <button className={`inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 ${variants[variant]} ${sizes[size]} ${className || ''}`} {...props}>{children}</button>;
};

const Input = ({ className, ...props }: any) => <input className={`flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 ${className || ''}`} {...props} />;

const Table = ({ className, children }: any) => <div className="relative w-full overflow-auto"><table className={`w-full caption-bottom text-sm ${className || ''}`}>{children}</table></div>;
const TableHeader = ({ className, children }: any) => <thead className={`[&_tr]:border-b ${className || ''}`}>{children}</thead>;
const TableBody = ({ className, children }: any) => <tbody className={`[&_tr:last-child]:border-0 ${className || ''}`}>{children}</tbody>;
const TableRow = ({ className, children }: any) => <tr className={`border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted ${className || ''}`}>{children}</tr>;
const TableHead = ({ className, children }: any) => <th className={`h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 ${className || ''}`}>{children}</th>;
const TableCell = ({ className, children }: any) => <td className={`p-4 align-middle [&:has([role=checkbox])]:pr-0 ${className || ''}`}>{children}</td>;

const TabsContext = createContext<any>(null);
const Tabs = ({ value, onValueChange, children, className }: any) => <TabsContext.Provider value={{ value, onValueChange }}><div className={className}>{children}</div></TabsContext.Provider>;
const TabsList = ({ className, children }: any) => <div className={`inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground ${className || ''}`}>{children}</div>;
const TabsTrigger = ({ value, children, className }: any) => {
  const { value: selectedValue, onValueChange } = useContext(TabsContext);
  return <button onClick={() => onValueChange(value)} className={`inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 ${selectedValue === value ? 'bg-background text-foreground shadow-sm' : ''} ${className || ''}`}>{children}</button>;
};
const TabsContent = ({ value, children, className }: any) => {
  const { value: selectedValue } = useContext(TabsContext);
  if (value !== selectedValue) return null;
  return <div className={`mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 ${className || ''}`}>{children}</div>;
};

const Progress = ({ value, className }: any) => <div className={`relative h-4 w-full overflow-hidden rounded-full bg-secondary ${className || ''}`}><div className="h-full w-full flex-1 bg-primary transition-all" style={{ transform: `translateX(-${100 - (value || 0)}%)` }} /></div>;

const NativeSelect = ({ value, onChange, options, placeholder, className }: any) => (
  <div className={`relative ${className}`}>
    <select
      value={value}
      onChange={(e) => onChange(e.target.value)}
      className="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 appearance-none"
    >
      <option value="" disabled>{placeholder}</option>
      {options.map((opt: any) => (
        <option key={opt.value} value={opt.value}>{opt.label}</option>
      ))}
    </select>
    <div className="absolute right-3 top-3 pointer-events-none">
      <ArrowDownRight className="h-4 w-4 text-muted-foreground opacity-50" />
    </div>
  </div>
);

// --- FALLBACK DATA (Defined outside component to be available immediately) ---

const FALLBACK_SUMMARY = {
  exposure_score: 72,
  critical_high_risk: 323,
  critical_count: 89,
  high_count: 234,
  exploited_in_wild: 12,
  weaponized: 28,
  active_threats: 47,
  patch_coverage: 85.2
};

const FALLBACK_THREATS = [
  {
    id: 1,
    type: 'Critical Threat Match',
    title: 'CVE-2024-12345: Apache RCE Actively Exploited by APT29',
    timestamp: '5 minutes ago',
    severity: 'Critical',
    threatActor: 'APT29 (Cozy Bear)',
    exploitAvailability: 'Exploited in Wild',
    businessImpact: 'Customer data exposure risk. Potential regulatory violation (GDPR).',
    affectedUnits: ['Finance', 'Customer Services'],
    riskScoreImpact: '+2.3 points',
    assetCount: 23,
    acknowledged: false
  },
  {
    id: 2,
    type: 'Zero-Day Alert',
    title: 'CVE-2024-XXXXX: Windows Kernel Zero-Day Discovered',
    timestamp: '2 hours ago',
    severity: 'High',
    threatActor: 'Unknown',
    exploitAvailability: 'Zero-Day (No patch available)',
    businessImpact: 'Privilege escalation vulnerability affecting all Windows endpoints.',
    affectedUnits: ['IT Operations', 'Corporate IT', 'Development'],
    riskScoreImpact: '+1.8 points',
    assetCount: 145,
    acknowledged: false
  },
  {
    id: 3,
    type: 'Patch Available',
    title: 'CVE-2024-33333: Buffer Overflow - Patch Released',
    timestamp: '4 hours ago',
    severity: 'High',
    threatActor: 'FIN7 (Carbanak)',
    exploitAvailability: 'Weaponized - Public PoC',
    businessImpact: 'Network service compromise. Lateral movement risk across production network.',
    affectedUnits: ['IT Operations'],
    riskScoreImpact: '+1.2 points',
    assetCount: 8,
    acknowledged: true
  }
];

const FALLBACK_SEVERITY = [
  { name: 'Critical', value: 89, trend: 'up', change: '+12', color: '#ef4444' },
  { name: 'High', value: 234, trend: 'down', change: '-18', color: '#f97316' },
  { name: 'Medium', value: 456, trend: 'up', change: '+23', color: '#eab308' },
  { name: 'Low', value: 123, trend: 'down', change: '-8', color: '#22c55e' }
];

const FALLBACK_PATCH_TREND = [
  { day: 5, patches: 12 },
  { day: 10, patches: 23 },
  { day: 15, patches: 35 },
  { day: 20, patches: 48 },
  { day: 25, patches: 59 },
  { day: 30, patches: 71 }
];

const FALLBACK_PATCH_SUMMARY = { total_30d: 71, avg_daily: 2.4 };

const FALLBACK_EXPOSED_UNITS = [
  { unit: 'Finance', riskScore: 8.9, trend: 'worsening', change: '+0.7', vulnerabilities: 45, critical: 8 },
  { unit: 'IT Operations', riskScore: 7.2, trend: 'stable', change: '+0.1', vulnerabilities: 67, critical: 12 },
  { unit: 'Development', riskScore: 6.1, trend: 'improving', change: '-0.3', vulnerabilities: 23, critical: 3 }
];

const FALLBACK_TOP_RISK_VULNS = [
  {
    id: 'CVE-2024-12345',
    title: 'Remote Code Execution in Apache HTTP Server',
    cvss: 9.8,
    exploitability: 'Exploited in Wild',
    affectedCriticalSystems: 23,
    businessUnits: ['Finance', 'Customer Services', 'IT Operations'],
    riskContribution: '18.5%',
    exposureScore: 95,
    threatActors: ['APT29', 'Lazarus Group']
  },
  {
    id: 'CVE-2024-33333',
    title: 'Buffer Overflow in Network Service',
    cvss: 7.5,
    exploitability: 'Weaponized',
    affectedCriticalSystems: 8,
    businessUnits: ['IT Operations'],
    riskContribution: '12.3%',
    exposureScore: 82,
    threatActors: ['FIN7']
  },
  {
    id: 'CVE-2024-11111',
    title: 'SQL Injection in MySQL Database',
    cvss: 8.1,
    exploitability: 'PoC Available',
    affectedCriticalSystems: 5,
    businessUnits: ['Development', 'Finance'],
    riskContribution: '9.7%',
    exposureScore: 74,
    threatActors: []
  }
];

const FALLBACK_AT_RISK_ASSETS = [
  {
    name: 'Finance Database Cluster',
    type: 'Database',
    vulnerabilityCount: 12,
    criticalVulns: 3,
    riskScore: 9.2,
    trend: 'worsening',
    change: '+0.8',
    criticality: 'Critical',
    businessUnit: 'Finance'
  },
  {
    name: 'Customer Portal (web-app-prod)',
    type: 'Web Application',
    vulnerabilityCount: 8,
    criticalVulns: 2,
    riskScore: 8.5,
    trend: 'stable',
    change: '0.0',
    criticality: 'High',
    businessUnit: 'Customer Services'
  },
  {
    name: 'Production API Gateway',
    type: 'Infrastructure',
    vulnerabilityCount: 15,
    criticalVulns: 4,
    riskScore: 8.8,
    trend: 'improving',
    change: '-0.4',
    criticality: 'Critical',
    businessUnit: 'IT Operations'
  }
];

const FALLBACK_VULNERABILITIES = [
  {
    id: 'CVE-2024-12345',
    title: 'Remote Code Execution in Apache HTTP Server',
    cvss_score: 9.8,
    severity: 'Critical',
    status: 'Open',
    asset_count: 23,
    first_detected: '2024-11-15',
    age_days: 13,
    exploitability: 'Exploited in Wild',
    businessUnits: ['Finance', 'Customer Services', 'IT Operations'],
    assetCriticality: 95,
    exposureScore: 95,
    riskScore: 9.5,
    patch_available: true,
    threat_actors: ['APT29', 'Lazarus Group']
  },
  {
    id: 'CVE-2024-11111',
    title: 'SQL Injection in MySQL Database',
    cvss_score: 8.1,
    severity: 'High',
    status: 'In Progress',
    asset_count: 5,
    first_detected: '2024-10-20',
    age_days: 39,
    exploitability: 'PoC Available',
    businessUnits: ['Development', 'Finance'],
    assetCriticality: 82,
    exposureScore: 74,
    riskScore: 7.8,
    patch_available: true,
    threat_actors: []
  },
  {
    id: 'CVE-2024-22222',
    title: 'Cross-Site Scripting in Web Application',
    cvss_score: 6.1,
    severity: 'Medium',
    status: 'Patched',
    asset_count: 12,
    first_detected: '2024-09-15',
    age_days: 74,
    exploitability: 'None',
    businessUnits: ['Customer Services'],
    assetCriticality: 68,
    exposureScore: 45,
    riskScore: 5.2,
    patch_available: true,
    threat_actors: []
  },
  {
    id: 'CVE-2024-33333',
    title: 'Buffer Overflow in Network Service',
    cvss_score: 7.5,
    severity: 'High',
    status: 'Open',
    asset_count: 8,
    first_detected: '2024-11-01',
    age_days: 27,
    exploitability: 'Weaponized',
    businessUnits: ['IT Operations'],
    assetCriticality: 88,
    exposureScore: 82,
    riskScore: 8.3,
    patch_available: false,
    threat_actors: ['FIN7']
  }
];

// --- MAIN MODULE ---

interface VulnerabilityModuleProps {
  onModuleChange?: (module: string) => void;
}

export function VulnerabilityModule({ onModuleChange }: VulnerabilityModuleProps = {}) {
  const [searchTerm, setSearchTerm] = useState('');
  const [severityFilter, setSeverityFilter] = useState('all');
  const [statusFilter, setStatusFilter] = useState('all');
  const [riskScoreFilter, setRiskScoreFilter] = useState('all');
  const [activeTab, setActiveTab] = useState<'dashboard' | 'vulnerabilities'>('dashboard');

  // API data states - Initialized with Fallback Data
  const [summary, setSummary] = useState<any>(FALLBACK_SUMMARY);
  const [activeThreats, setActiveThreats] = useState<any[]>(FALLBACK_THREATS);
  const [severityDistribution, setSeverityDistribution] = useState<any[]>(FALLBACK_SEVERITY);
  const [patchVelocityTrend, setPatchVelocityTrend] = useState<any[]>(FALLBACK_PATCH_TREND);
  const [patchVelocitySummary, setPatchVelocitySummary] = useState<any>(FALLBACK_PATCH_SUMMARY);
  const [vulnerabilities, setVulnerabilities] = useState<any[]>(FALLBACK_VULNERABILITIES);
  const [loading, setLoading] = useState(true);

  // Constants for items that don't have API endpoints yet
  const currentExposedUnits = FALLBACK_EXPOSED_UNITS;
  const currentTopRiskVulns = FALLBACK_TOP_RISK_VULNS;
  const currentAtRiskAssets = FALLBACK_AT_RISK_ASSETS;

  useEffect(() => {
    let isMounted = true;
    const fetchAllData = async () => {
      // Don't set loading true here to keep showing fallback data while "hydrating" with real data
      // setLoading(true); 
      try {
        const fetchWithFallback = async (url: string) => {
          try {
            const res = await fetch(url);
            if (!res.ok) throw new Error('Not OK');
            return await res.json();
          } catch (e) {
            return null;
          }
        };

        // CORRECTED PORT to 5000 to match Python/Flask default
        const [
          summaryRes,
          threatsRes,
          distRes,
          velocityRes,
          inventoryRes
        ] = await Promise.all([
          fetchWithFallback('http://127.0.0.1:5000/api/vulnerabilities/summary'),
          fetchWithFallback('http://127.0.0.1:5000/api/vulnerabilities/active-threats'),
          fetchWithFallback('http://127.0.0.1:5000/api/vulnerabilities/severity-distribution'),
          fetchWithFallback('http://127.0.0.1:5000/api/vulnerabilities/patch-velocity'),
          fetchWithFallback('http://127.0.0.1:5000/api/vulnerabilities/inventory')
        ]);

        if (isMounted) {
          if (summaryRes) setSummary(summaryRes);
          if (threatsRes && threatsRes.threats && threatsRes.threats.length > 0) setActiveThreats(threatsRes.threats);
          if (distRes && distRes.distribution && distRes.distribution.length > 0) setSeverityDistribution(distRes.distribution);
          if (velocityRes && velocityRes.trend && velocityRes.trend.length > 0) setPatchVelocityTrend(velocityRes.trend);
          if (velocityRes && velocityRes.summary) setPatchVelocitySummary(velocityRes.summary);
          if (inventoryRes && inventoryRes.vulnerabilities && inventoryRes.vulnerabilities.length > 0) setVulnerabilities(inventoryRes.vulnerabilities);
        }
      } catch (err) {
        console.warn('Using fallback data due to connection error');
      } finally {
        if (isMounted) setLoading(false);
      }
    };

    fetchAllData();
    return () => { isMounted = false; };
  }, []);

  // Helper functions with SAFETY CHECKS
  const getSeverityColor = (severity: any) => {
    const safeSeverity = String(severity || '').toLowerCase();
    switch (safeSeverity) {
      case 'critical': return 'destructive';
      case 'high': return 'default';
      case 'medium': return 'secondary';
      case 'low': return 'outline';
      default: return 'outline';
    }
  };

  const getStatusColor = (status: any) => {
    const safeStatus = String(status || '').toLowerCase();
    switch (safeStatus) {
      case 'open': return 'destructive';
      case 'in progress': return 'default';
      case 'patched': return 'outline';
      case 'accepted risk': return 'secondary';
      default: return 'outline';
    }
  };

  const getCVSSColor = (score: number = 0) => {
    if (score >= 9.0) return 'text-red-600';
    if (score >= 7.0) return 'text-orange-600';
    if (score >= 4.0) return 'text-yellow-600';
    return 'text-green-600';
  };

  const getExploitabilityColor = (exploitability: any) => {
    const lower = String(exploitability || '').toLowerCase();
    if (lower.includes('exploited') || lower.includes('zero-day')) return 'bg-red-600 text-white border-red-700';
    if (lower.includes('weaponized')) return 'bg-orange-600 text-white border-orange-700';
    if (lower.includes('poc')) return 'bg-yellow-600 text-white border-yellow-700';
    return 'bg-gray-400 text-white border-gray-500';
  };

  const getTrendIcon = (trend: any) => {
    const lower = String(trend || '').toLowerCase();
    if (lower === 'up' || lower === 'worsening') return <ArrowUpRight className="h-4 w-4 text-red-600" />;
    if (lower === 'down' || lower === 'improving') return <ArrowDownRight className="h-4 w-4 text-green-600" />;
    return <Minus className="h-4 w-4 text-gray-600" />;
  };

  const handleScanNow = () => {
    toast.success('Vulnerability scan initiated. Results will be available in 15-20 minutes.');
  };

  const handleAcknowledgeAlert = (alertId: number) => {
    toast.success(`Alert #${alertId} acknowledged and marked for review.`);
  };

  const handleAssignOwner = (alertId: number) => {
    toast.success(`Alert #${alertId} assigned to Security Operations team.`);
  };

  // Safe filtering
  const filteredVulnerabilities = (vulnerabilities || [])
    .filter(vuln => vuln && vuln.id && vuln.title)
    .filter(vuln => {
      const searchLower = searchTerm.toLowerCase();
      const idMatch = vuln.id.toLowerCase().includes(searchLower);
      const titleMatch = vuln.title.toLowerCase().includes(searchLower);
      const severityMatch = severityFilter === 'all' || (String(vuln.severity || '')).toLowerCase() === severityFilter.toLowerCase();
      const statusMatch = statusFilter === 'all' || (String(vuln.status || '')).toLowerCase() === statusFilter.toLowerCase();
      const riskMatch = riskScoreFilter === 'all' ||
        (riskScoreFilter === 'critical' && (vuln.riskScore || 0) >= 9.0) ||
        (riskScoreFilter === 'high' && (vuln.riskScore || 0) >= 7.0 && (vuln.riskScore || 0) < 9.0) ||
        (riskScoreFilter === 'medium' && (vuln.riskScore || 0) >= 4.0 && (vuln.riskScore || 0) < 7.0) ||
        (riskScoreFilter === 'low' && (vuln.riskScore || 0) < 4.0);

      return (idMatch || titleMatch) && severityMatch && statusMatch && riskMatch;
    });

  if (loading) {
    return (
      <div className="flex flex-col items-center justify-center h-96 space-y-4">
        <Loader2 className="h-12 w-12 animate-spin text-blue-600" />
        <p className="text-lg text-muted-foreground">Loading Vulnerability Module...</p>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as any)} className="w-full">
        <TabsList className="grid w-full grid-cols-2">
          <TabsTrigger value="dashboard">Risk Dashboard</TabsTrigger>
          <TabsTrigger value="vulnerabilities">Vulnerability Inventory</TabsTrigger>
        </TabsList>

        <TabsContent value="dashboard" className="space-y-6">
          {/* KPI Row 1 */}
          <div className="grid gap-4 md:grid-cols-4">
            <Card className="border-2">
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">Exposure Score</CardTitle>
                <Target className="h-4 w-4 text-blue-600" />
              </CardHeader>
              <CardContent>
                <div className="text-3xl font-bold text-blue-600">{summary.exposure_score}</div>
                <div className="flex items-center space-x-1 text-xs mt-1">
                  {getTrendIcon('improving')}
                  <span className="text-green-600 font-semibold">-6 pts</span>
                  <span className="text-muted-foreground">MoM</span>
                </div>
                <div className="mt-3">
                  <ResponsiveContainer width="100%" height={40}>
                    <LineChart data={[
                      { month: 'Jul', score: 85 },
                      { month: 'Aug', score: 82 },
                      { month: 'Sep', score: 80 },
                      { month: 'Oct', score: 78 },
                      { month: 'Nov', score: 75 },
                      { month: 'Dec', score: summary.exposure_score }
                    ]}>
                      <Line type="monotone" dataKey="score" stroke="#2563eb" strokeWidth={2} dot={false} />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              </CardContent>
            </Card>

            <Card className="border-2 border-red-200 bg-red-50/30">
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">Critical & High Risk</CardTitle>
                <Shield className="h-4 w-4 text-red-600" />
              </CardHeader>
              <CardContent>
                <div className="text-3xl font-bold text-red-600">{summary.critical_high_risk}</div>
                <div className="text-xs text-muted-foreground mt-1">{summary.critical_count} Critical, {summary.high_count} High</div>
                <div className="mt-3 space-y-1">
                  <div className="flex items-center justify-between text-xs">
                    <span className="text-red-700">Exploited in Wild:</span>
                    <span className="font-bold text-red-700">{summary.exploited_in_wild}</span>
                  </div>
                  <div className="flex items-center justify-between text-xs">
                    <span className="text-orange-700">Weaponized:</span>
                    <span className="font-bold text-orange-700">{summary.weaponized}</span>
                  </div>
                </div>
              </CardContent>
            </Card>

            <Card className="border-2 border-orange-200 bg-orange-50/30">
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">Active Threats</CardTitle>
                <Flame className="h-4 w-4 text-orange-600" />
              </CardHeader>
              <CardContent>
                <div className="text-3xl font-bold text-orange-600">{summary.active_threats}</div>
                <div className="text-xs text-muted-foreground mt-1">With known exploits</div>
                <div className="mt-3 space-y-1">
                  <div className="flex items-center space-x-1 text-xs">
                    <Badge variant="destructive" className="text-xs">APT29</Badge>
                    <Badge variant="destructive" className="text-xs">FIN7</Badge>
                  </div>
                  <div className="text-xs text-orange-700">Active threat actors: 4</div>
                </div>
              </CardContent>
            </Card>

            <Card className="border-2 border-green-200 bg-green-50/30">
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">Patch Coverage</CardTitle>
                <CheckCircle className="h-4 w-4 text-green-600" />
              </CardHeader>
              <CardContent>
                <div className="text-3xl font-bold text-green-600">{summary.patch_coverage?.toFixed(1) || 0}%</div>
                <div className="flex items-center space-x-1 text-xs mt-1">
                  <TrendingUp className="h-3 w-3 text-green-600" />
                  <span className="text-green-600 font-semibold">+1.3%</span>
                  <span className="text-muted-foreground">MoM</span>
                </div>
                <div className="mt-2 text-xs text-muted-foreground">
                  SLA Benchmark: 85% âœ“
                </div>
              </CardContent>
            </Card>
          </div>

          {/* Remediation Velocity + Exploitability + Backlog */}
          <div className="grid gap-4 md:grid-cols-3">
            <Card>
              <CardHeader>
                <CardTitle className="text-base">Remediation Velocity (MTTR)</CardTitle>
                <CardDescription>Mean time to resolve by severity</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="bg-red-50 border-2 border-red-200 rounded-lg p-3">
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm font-semibold text-red-900">Critical</span>
                    <Badge variant="destructive">SLA: 5 days</Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <div className="text-2xl font-bold text-red-600">4.2 days</div>
                    <div className="flex items-center space-x-1 text-sm">
                      <ArrowDownRight className="h-4 w-4 text-green-600" />
                      <span className="text-green-600 font-semibold">-1.3 days</span>
                    </div>
                  </div>
                </div>
                <div className="bg-orange-50 border-2 border-orange-200 rounded-lg p-3">
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm font-semibold text-orange-900">High</span>
                    <Badge className="bg-orange-600 text-white">SLA: 15 days</Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <div className="text-2xl font-bold text-orange-600">12.5 days</div>
                    <div className="flex items-center space-x-1 text-sm">
                      <ArrowUpRight className="h-4 w-4 text-red-600" />
                      <span className="text-red-600 font-semibold">+2.1 days</span>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle className="text-base">Exploitability Breakdown</CardTitle>
                <CardDescription>Threat level classification</CardDescription>
              </CardHeader>
              <CardContent className="space-y-3">
                <div className="flex items-center justify-between p-3 border-2 rounded-lg">
                  <div className="flex items-center space-x-3">
                    <div className="text-2xl font-bold text-gray-400">#1</div>
                    <div>
                      <div className="font-semibold text-sm">Zero-Day</div>
                      <Badge variant="outline" className="text-xs mt-1">Critical</Badge>
                    </div>
                  </div>
                  <div className="text-2xl font-bold text-purple-600">3</div>
                </div>
                <div className="flex items-center justify-between p-3 border-2 rounded-lg">
                  <div className="flex items-center space-x-3">
                    <div className="text-2xl font-bold text-gray-400">#2</div>
                    <div>
                      <div className="font-semibold text-sm">Exploited in Wild</div>
                      <Badge variant="outline" className="text-xs mt-1">Critical</Badge>
                    </div>
                  </div>
                  <div className="text-2xl font-bold text-red-600">12</div>
                </div>
                <div className="flex items-center justify-between p-3 border-2 rounded-lg">
                  <div className="flex items-center space-x-3">
                    <div className="text-2xl font-bold text-gray-400">#3</div>
                    <div>
                      <div className="font-semibold text-sm">Weaponized</div>
                      <Badge variant="outline" className="text-xs mt-1">High</Badge>
                    </div>
                  </div>
                  <div className="text-2xl font-bold text-orange-600">28</div>
                </div>
                <div className="flex items-center justify-between p-3 border-2 rounded-lg">
                  <div className="flex items-center space-x-3">
                    <div className="text-2xl font-bold text-gray-400">#4</div>
                    <div>
                      <div className="font-semibold text-sm">PoC Available</div>
                      <Badge variant="outline" className="text-xs mt-1">High</Badge>
                    </div>
                  </div>
                  <div className="text-2xl font-bold text-yellow-600">45</div>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle className="text-base">Backlog Aging</CardTitle>
                <CardDescription>Vulnerabilities by age threshold</CardDescription>
              </CardHeader>
              <CardContent className="space-y-3">
                <div className="bg-red-50 border-2 border-red-300 rounded-lg p-3">
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="text-xs text-red-700 font-semibold">&gt; 90 Days</div>
                      <div className="text-2xl font-bold text-red-600">23</div>
                    </div>
                    <Clock className="h-8 w-8 text-red-400" />
                  </div>
                </div>
                <div className="bg-orange-50 border-2 border-orange-300 rounded-lg p-3">
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="text-xs text-orange-700 font-semibold">&gt; 60 Days</div>
                      <div className="text-2xl font-bold text-orange-600">41</div>
                    </div>
                    <Clock className="h-8 w-8 text-orange-400" />
                  </div>
                </div>
                <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-3">
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="text-xs text-yellow-700 font-semibold">&gt; 30 Days</div>
                      <div className="text-2xl font-bold text-yellow-600">67</div>
                    </div>
                    <Clock className="h-8 w-8 text-yellow-400" />
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>

          {/* Top Exposed Business Units */}
          <Card className="shadow-lg">
            <CardHeader>
              <CardTitle className="flex items-center space-x-2">
                <Building className="h-5 w-5 text-indigo-600" />
                <span>Top Exposed Business Units</span>
              </CardTitle>
              <CardDescription>Departments with highest vulnerability risk scores</CardDescription>
            </CardHeader>
            <CardContent>
              <div className="space-y-3">
                {(currentExposedUnits || []).map((unit, idx) => (
                  <div key={`exposed-unit-${idx}`} className="border-2 rounded-lg p-4 bg-gradient-to-r from-gray-50 to-white">
                    <div className="flex items-center justify-between mb-3">
                      <div className="flex items-center space-x-3">
                        <div className="text-2xl font-bold text-gray-400">#{idx + 1}</div>
                        <div>
                          <h4 className="font-bold">{unit.unit}</h4>
                          <div className="flex items-center space-x-2 mt-1">
                            {getTrendIcon(unit.trend)}
                            <span className={`text-sm font-semibold ${unit.trend === 'worsening' ? 'text-red-600' : unit.trend === 'improving' ? 'text-green-600' : 'text-gray-600'}`}>
                              {unit.change}
                            </span>
                          </div>
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="text-3xl font-bold text-red-600">{unit.riskScore}</div>
                        <div className="text-xs text-muted-foreground">Risk Score</div>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                      <div className="bg-white border rounded-lg p-2 text-center">
                        <div className="text-xl font-bold text-purple-600">{unit.vulnerabilities}</div>
                        <div className="text-xs text-muted-foreground">Total Vulns</div>
                      </div>
                      <div className="bg-white border rounded-lg p-2 text-center">
                        <div className="text-xl font-bold text-red-600">{unit.critical}</div>
                        <div className="text-xs text-muted-foreground">Critical</div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>

          {/* Security Alerts */}
          <Card className="shadow-lg">
            <CardHeader>
              <div className="flex items-center justify-between">
                <div>
                  <CardTitle className="flex items-center space-x-2">
                    <Bell className="h-5 w-5 text-red-600" />
                    <span>Security Alerts</span>
                  </CardTitle>
                  <CardDescription>Real-time threat intelligence and vulnerability alerts</CardDescription>
                </div>
              </div>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {(activeThreats || []).map((alert) => (
                  <div
                    key={`alert-${alert.id}`}
                    className={`border-2 rounded-lg p-5 ${alert.severity === 'Critical' ? 'border-red-300 bg-red-50/30' : 'border-orange-300 bg-orange-50/30'} ${alert.acknowledged ? 'opacity-60' : ''}`}
                  >
                    <div className="flex items-start justify-between mb-3">
                      <div className="flex-1">
                        <div className="flex items-center space-x-2 mb-2">
                          <Badge variant={getSeverityColor(alert.severity)} className="font-bold">
                            {alert.severity}
                          </Badge>
                          <Badge variant="outline">{alert.type}</Badge>
                          <span className="text-sm text-muted-foreground">{alert.timestamp}</span>
                          {alert.acknowledged && (
                            <Badge variant="outline" className="bg-green-100 text-green-700">
                              <Check className="h-3 w-3 mr-1" />
                              Acknowledged
                            </Badge>
                          )}
                        </div>
                        <h4 className="font-bold text-lg mb-2">{alert.title}</h4>
                      </div>
                      <div className="ml-4 text-right">
                        <div className="text-2xl font-bold text-red-600">{alert.riskScoreImpact}</div>
                        <div className="text-xs text-muted-foreground">Risk Impact</div>
                      </div>
                    </div>

                    <div className="grid gap-3 md:grid-cols-3 mb-4">
                      <div className="bg-white border-2 rounded-lg p-3">
                        <div className="text-xs text-muted-foreground mb-1">Threat Actor</div>
                        <Badge variant="destructive" className="font-bold">{alert.threatActor}</Badge>
                      </div>
                      <div className="bg-white border-2 rounded-lg p-3">
                        <div className="text-xs text-muted-foreground mb-1">Exploit Availability</div>
                        <Badge className={`${getExploitabilityColor(alert.exploitAvailability)} font-bold text-xs`}>
                          {alert.exploitAvailability}
                        </Badge>
                      </div>
                      <div className="bg-white border-2 rounded-lg p-3">
                        <div className="text-xs text-muted-foreground mb-1">Affected Assets</div>
                        <div className="font-bold text-gray-900">{alert.assetCount} systems</div>
                      </div>
                    </div>

                    <div className="bg-white border rounded-lg p-3 mb-3">
                      <div className="text-sm font-semibold text-gray-700 mb-1">Business Impact</div>
                      <p className="text-sm text-gray-600">{alert.businessImpact}</p>
                    </div>

                    <div className="mb-4">
                      <div className="text-sm font-semibold text-gray-700 mb-2">Affected Business Units</div>
                      <div className="flex flex-wrap gap-2">
                        {(alert.affectedUnits || []).map((unit: string, idx: number) => (
                          <Badge key={`unit-${idx}`} variant="secondary" className="text-sm">
                            <Building className="h-3 w-3 mr-1" />
                            {unit}
                          </Badge>
                        ))}
                      </div>
                    </div>

                    <div className="flex space-x-2">
                      <Button variant="outline" size="sm">
                        <Eye className="h-4 w-4 mr-1" />
                        View Details
                      </Button>
                      {!alert.acknowledged && (
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => handleAcknowledgeAlert(alert.id)}
                        >
                          <Check className="h-4 w-4 mr-1" />
                          Acknowledge
                        </Button>
                      )}
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => handleAssignOwner(alert.id)}
                      >
                        <Users className="h-4 w-4 mr-1" />
                        Assign Owner
                      </Button>
                    </div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>

          {/* Vulnerability Severity & Patch Overview */}
          <div className="grid gap-6 lg:grid-cols-2">
            <Card className="shadow-lg">
              <CardHeader>
                <CardTitle>Vulnerability Severity Distribution</CardTitle>
                <CardDescription>Current landscape with monthly trends</CardDescription>
              </CardHeader>
              <CardContent>
                <ResponsiveContainer width="100%" height={250}>
                  <PieChart>
                    <Pie
                      data={severityDistribution}
                      cx="50%"
                      cy="50%"
                      innerRadius={60}
                      outerRadius={100}
                      dataKey="value"
                      label={(entry) => `${entry.name}: ${entry.value}`}
                    >
                      {(severityDistribution || []).map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={entry.color} />
                      ))}
                    </Pie>
                    <RechartsTooltip />
                  </PieChart>
                </ResponsiveContainer>
                <div className="mt-6 space-y-2">
                  {(severityDistribution || []).map((entry, index) => (
                    <div key={`severity-list-${index}`} className="flex items-center justify-between p-2 border rounded-lg">
                      <div className="flex items-center space-x-2">
                        <div className="w-3 h-3 rounded-full" style={{ backgroundColor: entry.color }} />
                        <span className="font-medium">{entry.name}</span>
                      </div>
                      <div className="flex items-center space-x-3">
                        <span className="font-bold text-lg">{entry.value}</span>
                        <div className="flex items-center space-x-1">
                          {getTrendIcon(entry.trend)}
                          <span className={`text-sm font-semibold ${entry.trend === 'up' ? 'text-red-600' : 'text-green-600'}`}>
                            {entry.change}
                          </span>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>

            <Card className="shadow-lg">
              <CardHeader>
                <CardTitle>Patch Velocity Trend</CardTitle>
                <CardDescription>30-day remediation performance</CardDescription>
              </CardHeader>
              <CardContent>
                <ResponsiveContainer width="100%" height={250}>
                  <AreaChart data={patchVelocityTrend}>
                    <defs>
                      <linearGradient id="colorPatches" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor="#22c55e" stopOpacity={0.8}/>
                        <stop offset="95%" stopColor="#22c55e" stopOpacity={0}/>
                      </linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="day" />
                    <YAxis />
                    <RechartsTooltip />
                    <Area type="monotone" dataKey="patches" stroke="#22c55e" fillOpacity={1} fill="url(#colorPatches)" />
                  </AreaChart>
                </ResponsiveContainer>
                <div className="mt-4 grid grid-cols-2 gap-4">
                  <div className="bg-green-50 border-2 border-green-200 rounded-lg p-3 text-center">
                    <div className="text-2xl font-bold text-green-600">{patchVelocitySummary.total_30d}</div>
                    <div className="text-sm text-muted-foreground">Patches Applied (30d)</div>
                  </div>
                  <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-3 text-center">
                    <div className="text-2xl font-bold text-blue-600">{patchVelocitySummary.avg_daily}/day</div>
                    <div className="text-sm text-muted-foreground">Avg Velocity</div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>

          {/* Top Risk-Contributing Vulnerabilities */}
          <Card className="shadow-lg">
            <CardHeader>
              <CardTitle className="flex items-center space-x-2">
                <FileWarning className="h-5 w-5 text-red-600" />
                <span>Top Risk-Contributing Vulnerabilities</span>
              </CardTitle>
              <CardDescription>CVEs with highest impact on organizational risk score</CardDescription>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {(currentTopRiskVulns || []).map((vuln, idx) => (
                  <div key={`risk-vuln-${vuln.id}`} className="border-2 border-purple-200 rounded-lg p-5 bg-purple-50/30">
                    <div className="flex items-start justify-between mb-3">
                      <div className="flex items-center space-x-3">
                        <div className="text-3xl font-bold text-purple-400">#{idx + 1}</div>
                        <div>
                          <div className="flex items-center space-x-2 mb-1">
                            <span className="font-mono font-bold">{vuln.id}</span>
                            <Badge variant="destructive" className="font-bold">
                              CVSS {vuln.cvss}
                            </Badge>
                            <Badge className={`${getExploitabilityColor(vuln.exploitability)} font-bold`}>
                              {vuln.exploitability}
                            </Badge>
                          </div>
                          <h4 className="font-bold text-lg">{vuln.title}</h4>
                        </div>
                      </div>
                      <div className="text-right ml-4">
                        <div className="text-3xl font-bold text-purple-600">{vuln.riskContribution}</div>
                        <div className="text-xs text-muted-foreground">Risk Contribution</div>
                      </div>
                    </div>

                    <div className="grid gap-3 md:grid-cols-4 mb-3">
                      <div className="bg-white border-2 rounded-lg p-3 text-center">
                        <div className="text-xl font-bold text-red-600">{vuln.affectedCriticalSystems}</div>
                        <div className="text-xs text-muted-foreground">Critical Systems</div>
                      </div>
                      <div className="bg-white border-2 rounded-lg p-3 text-center">
                        <div className="text-xl font-bold text-purple-600">{vuln.exposureScore}</div>
                        <div className="text-xs text-muted-foreground">Exposure Score</div>
                      </div>
                      <div className="bg-white border-2 rounded-lg p-3 text-center">
                        <div className="text-xl font-bold text-gray-900">{vuln.businessUnits.length}</div>
                        <div className="text-xs text-muted-foreground">Business Units</div>
                      </div>
                      <div className="bg-white border-2 rounded-lg p-3 text-center">
                        <div className="text-xl font-bold text-orange-600">{vuln.threatActors.length}</div>
                        <div className="text-xs text-muted-foreground">Threat Actors</div>
                      </div>
                    </div>

                    <div className="mb-3">
                      <div className="text-sm font-semibold text-gray-700 mb-2">Affected Business Units</div>
                      <div className="flex flex-wrap gap-2">
                        {(vuln.businessUnits || []).map((unit: string, idx: number) => (
                          <Badge key={`risk-unit-${idx}`} variant="secondary">
                            <Building className="h-3 w-3 mr-1" />
                            {unit}
                          </Badge>
                        ))}
                      </div>
                    </div>

                    {vuln.threatActors && vuln.threatActors.length > 0 && (
                      <div>
                        <div className="text-sm font-semibold text-gray-700 mb-2">Active Threat Actors</div>
                        <div className="flex flex-wrap gap-2">
                          {vuln.threatActors.map((actor: string, idx: number) => (
                            <Badge key={`risk-actor-${idx}`} variant="destructive">{actor}</Badge>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>

          {/* At-Risk Assets/Applications */}
          <Card className="shadow-lg">
            <CardHeader>
              <CardTitle className="flex items-center space-x-2">
                <Activity className="h-5 w-5 text-indigo-600" />
                <span>At-Risk Assets & Applications</span>
              </CardTitle>
              <CardDescription>Systems with highest vulnerability concentration and criticality</CardDescription>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {(currentAtRiskAssets || []).map((asset, idx) => (
                  <div key={`asset-${idx}`} className="border-2 rounded-lg p-4 bg-gradient-to-r from-indigo-50 to-white">
                    <div className="flex items-center justify-between mb-3">
                      <div className="flex items-center space-x-3">
                        <div className="text-2xl font-bold text-indigo-400">#{idx + 1}</div>
                        <div>
                          <h4 className="font-bold">{asset.name}</h4>
                          <div className="flex items-center space-x-2 mt-1">
                            <Badge variant="outline" className="text-xs">{asset.type}</Badge>
                            <Badge variant="outline" className="text-xs">{asset.businessUnit}</Badge>
                            <Badge className={`text-xs ${asset.criticality === 'Critical' ? 'bg-red-600 text-white' : 'bg-orange-600 text-white'}`}>
                              {asset.criticality}
                            </Badge>
                          </div>
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="flex items-center space-x-2">
                          <div className="text-3xl font-bold text-red-600">{asset.riskScore}</div>
                          {getTrendIcon(asset.trend)}
                          <span className={`text-sm font-semibold ${asset.trend === 'worsening' ? 'text-red-600' : asset.trend === 'improving' ? 'text-green-600' : 'text-gray-600'}`}>
                            {asset.change}
                          </span>
                        </div>
                        <div className="text-xs text-muted-foreground">Risk Score</div>
                      </div>
                    </div>

                    <div className="grid grid-cols-2 gap-3">
                      <div className="bg-white border-2 rounded-lg p-3 text-center">
                        <div className="text-2xl font-bold text-purple-600">{asset.vulnerabilityCount}</div>
                        <div className="text-xs text-muted-foreground">Total Vulnerabilities</div>
                      </div>
                      <div className="bg-white border-2 rounded-lg p-3 text-center">
                        <div className="text-2xl font-bold text-red-600">{asset.criticalVulns}</div>
                        <div className="text-xs text-muted-foreground">Critical Vulns</div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="vulnerabilities" className="space-y-6">
          <Card>
            <CardHeader>
              <div className="flex items-center justify-between">
                <div>
                  <CardTitle>Vulnerability Inventory</CardTitle>
                  <CardDescription>Comprehensive database with risk scoring and business impact analysis</CardDescription>
                </div>
                <Button onClick={handleScanNow}>
                  <RefreshCw className="h-4 w-4 mr-2" />
                  Scan Now
                </Button>
              </div>
            </CardHeader>
            <CardContent>
              <div className="grid gap-4 md:grid-cols-5 mb-6">
                <div className="md:col-span-2">
                  <div className="relative">
                    <Search className="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input
                      placeholder="Search CVE ID or title..."
                      className="pl-8"
                      value={searchTerm}
                      onChange={(e: any) => setSearchTerm(e.target.value)}
                    />
                  </div>
                </div>
                
                <NativeSelect 
                  value={severityFilter}
                  onChange={setSeverityFilter}
                  placeholder="Severity"
                  options={[
                    { value: 'all', label: 'All Severities' },
                    { value: 'critical', label: 'Critical' },
                    { value: 'high', label: 'High' },
                    { value: 'medium', label: 'Medium' },
                    { value: 'low', label: 'Low' },
                  ]}
                />

                <NativeSelect 
                  value={statusFilter}
                  onChange={setStatusFilter}
                  placeholder="Status"
                  options={[
                    { value: 'all', label: 'All Status' },
                    { value: 'open', label: 'Open' },
                    { value: 'in progress', label: 'In Progress' },
                    { value: 'patched', label: 'Patched' },
                  ]}
                />

                <NativeSelect 
                  value={riskScoreFilter}
                  onChange={setRiskScoreFilter}
                  placeholder="Risk Score"
                  options={[
                    { value: 'all', label: 'All Risk Scores' },
                    { value: 'critical', label: 'Critical (9.0+)' },
                    { value: 'high', label: 'High (7.0-8.9)' },
                    { value: 'medium', label: 'Medium (4.0-6.9)' },
                    { value: 'low', label: 'Low (< 4.0)' },
                  ]}
                />
              </div>

              <div className="border rounded-lg">
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead>CVE ID</TableHead>
                      <TableHead>Title</TableHead>
                      <TableHead>CVSS</TableHead>
                      <TableHead>Severity</TableHead>
                      <TableHead>Exploitability</TableHead>
                      <TableHead>Business Units</TableHead>
                      <TableHead>Asset Criticality</TableHead>
                      <TableHead>Exposure Score</TableHead>
                      <TableHead>Risk Score</TableHead>
                      <TableHead>Status</TableHead>
                      <TableHead>Age</TableHead>
                      <TableHead>Actions</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {filteredVulnerabilities.map((vuln) => (
                      <TableRow key={vuln.id}>
                        <TableCell className="font-mono font-semibold">{vuln.id}</TableCell>
                        <TableCell className="max-w-md">
                          <div className="font-medium">{vuln.title}</div>
                          {vuln.threat_actors && vuln.threat_actors.length > 0 && (
                            <div className="flex flex-wrap gap-1 mt-1">
                              {vuln.threat_actors.map((actor: string, idx: number) => (
                                <Badge key={`table-actor-${idx}`} variant="destructive" className="text-xs">{actor}</Badge>
                              ))}
                            </div>
                          )}
                        </TableCell>
                        <TableCell className={`font-bold ${getCVSSColor(vuln.cvss_score)}`}>{vuln.cvss_score}</TableCell>
                        <TableCell>
                          <Badge variant={getSeverityColor(vuln.severity)}>{vuln.severity}</Badge>
                        </TableCell>
                        <TableCell>
                          <Badge className={`${getExploitabilityColor(vuln.exploitability)} text-xs font-bold`}>
                            {vuln.exploitability}
                          </Badge>
                        </TableCell>
                        <TableCell>
                          <div className="flex flex-wrap gap-1 max-w-[150px]">
                            {(vuln.businessUnits || []).slice(0, 2).map((unit: string, idx: number) => (
                              <Badge key={`table-unit-${idx}`} variant="outline" className="text-xs">{unit}</Badge>
                            ))}
                            {vuln.businessUnits && vuln.businessUnits.length > 2 && (
                              <Badge variant="outline" className="text-xs">+{vuln.businessUnits.length - 2}</Badge>
                            )}
                          </div>
                        </TableCell>
                        <TableCell>
                          <div className="flex items-center space-x-2">
                            <Progress value={vuln.assetCriticality || 0} className="h-2 w-16" />
                            <span className="text-xs font-bold">{vuln.assetCriticality || 0}</span>
                          </div>
                        </TableCell>
                        <TableCell className="text-center font-bold">{vuln.exposureScore || 0}</TableCell>
                        <TableCell className={`font-bold ${getCVSSColor(vuln.riskScore || 0)}`}>{vuln.riskScore || 0}</TableCell>
                        <TableCell>
                          <Badge variant={getStatusColor(vuln.status)}>{vuln.status}</Badge>
                        </TableCell>
                        <TableCell>
                          <div className="flex items-center space-x-1">
                            <Clock className="h-3 w-3 text-muted-foreground" />
                            <span className={`text-sm font-medium ${vuln.age_days > 60 ? 'text-red-600' : vuln.age_days > 30 ? 'text-orange-600' : 'text-gray-900'}`}>
                              {vuln.age_days || 0}d
                            </span>
                          </div>
                        </TableCell>
                        <TableCell>
                          <Button variant="ghost" size="sm">
                            <Eye className="h-4 w-4 mr-1" />
                            Details
                          </Button>
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </div>

              <div className="mt-4 text-sm text-muted-foreground">
                Showing {filteredVulnerabilities.length} of {vulnerabilities.length} vulnerabilities
              </div>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
}